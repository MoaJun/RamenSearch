import{g,j as e}from"./index-Dq7NBkUu.js";import{R as S,r as d,p as P,q as N,n as j}from"./ui-D1brmElj.js";import{G as R,T as c}from"./ai-8rzRUgYl.js";const x={},h=x?.VITE_GEMINI_API_KEY||x?.GEMINI_API_KEY;h||console.warn("API_KEY is not set. Using mock data for AI features.");const A=new R({apiKey:h||""}),b=4320*60*1e3,p={requests:[],maxRequests:15,windowMs:6e4,canMakeRequest(){const a=Date.now();return this.requests=this.requests.filter(t=>a-t<this.windowMs),this.requests.length<this.maxRequests},recordRequest(){this.requests.push(Date.now())},getWaitTime(){if(this.requests.length===0)return 0;const a=Math.min(...this.requests);return Math.max(0,this.windowMs-(Date.now()-a))}};async function k(a,t){const n=await g.get(`summary_${a}`);if(n)return n;if(!h){const o={goodPoints:["濃厚でクリーミーな豚骨スープ","とろけるチャーシューが高評価"],badPoints:["週末は行列が長くなることがある","店内はカウンター席のみで狭め"],tips:["「替え玉」を「バリカタ」で頼むのが人気","卓上の無料トッピング（高菜、紅生姜）を活用すべし"]};return await g.set(`summary_${a}`,o,b),o}if(!p.canMakeRequest()){const o=p.getWaitTime();return console.warn(`Rate limit reached. Please wait ${Math.ceil(o/1e3)} seconds.`),{goodPoints:["API制限により一時的に要約を生成できません"],badPoints:[`${Math.ceil(o/1e3)}秒後に再度お試しください`],tips:["詳細なレビューは下記の個別レビューをご確認ください"]}}try{p.recordRequest();const o=t.length>4e3?t.substring(0,4e3)+"...":t,i=(await A.models.generateContent({model:"gemini-1.5-flash",contents:`以下のラーメン店のレビュー群を分析し、JSON形式で要約してください:

${o}

必ず以下のJSON形式で回答してください:
{"goodPoints":["良い点1","良い点2"],"badPoints":["改善点1","改善点2"],"tips":["ヒント1","ヒント2"]}`,config:{responseMimeType:"application/json",responseSchema:{type:c.OBJECT,properties:{goodPoints:{type:c.ARRAY,description:"この店の特に評価されている良い点や長所を箇条書きでまとめたリスト。最大4つ。",items:{type:c.STRING}},badPoints:{type:c.ARRAY,description:"この店の改善点や注意すべき点、人によっては短所と感じる可能性のある点を箇条書きでまとめたリスト。最大4つ。",items:{type:c.STRING}},tips:{type:c.ARRAY,description:"この店を訪れる際の裏技、おすすめの食べ方、注意点などのヒントを箇条書きでまとめたリスト。最大4つ。",items:{type:c.STRING}}}},systemInstruction:"あなたは経験豊富なフードジャーナリストです。レビューを分析して、必ず有効なJSON形式で回答してください。文字列には改行や特殊文字を含めず、短い箇条書きで要約してください。",maxOutputTokens:512,temperature:.2}})).text?.trim()||"";if(typeof i!="string")throw new Error("Invalid response format: response.text is not a string.");let s;try{const r=i.replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t");s=JSON.parse(r)}catch(r){console.error("JSON Parse Error:",r),console.error("Problematic JSON text:",i);const u=i.match(/\{.*\}/s);if(u)try{s=JSON.parse(u[0])}catch(m){throw console.error("Second parse attempt failed:",m),new Error(`Failed to parse JSON response: ${r instanceof Error?r.message:"Unknown error"}`)}else throw new Error("No valid JSON found in response")}if(s&&typeof s=="object"){const r={goodPoints:Array.isArray(s.goodPoints)?s.goodPoints:[],badPoints:Array.isArray(s.badPoints)?s.badPoints:[],tips:Array.isArray(s.tips)?s.tips:[]};if(r.goodPoints.length>0||r.badPoints.length>0||r.tips.length>0)return await g.set(`summary_${a}`,r,b),r}return{goodPoints:[],badPoints:[],tips:[]}}catch(o){return console.error("Error generating review summary with Gemini API:",o),{goodPoints:["API制限により一時的に要約を生成できません"],badPoints:["しばらく時間をおいて再度お試しください"],tips:["詳細なレビューは下記の個別レビューをご確認ください"]}}}const E=()=>e.jsx("div",{className:"space-y-4 animate-pulse",children:[...Array(3)].map((a,t)=>e.jsxs("div",{children:[e.jsx("div",{className:"h-5 w-32 bg-gray-200 dark:bg-gray-700 rounded-md mb-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-full bg-gray-200 dark:bg-gray-700 rounded-md"}),e.jsx("div",{className:"h-4 w-5/6 bg-gray-200 dark:bg-gray-700 rounded-md"})]})]},t))}),y=({title:a,points:t,icon:n,borderColorClass:o,textColorClass:l})=>!t||t.length===0?null:e.jsxs("div",{className:`bg-gray-50 dark:bg-gray-800/50 border-l-4 p-4 rounded-r-lg ${o}`,children:[e.jsxs("h4",{className:`font-bold flex items-center mb-2 ${l}`,children:[n,e.jsx("span",{className:"ml-2",children:a})]}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-gray-700 dark:text-gray-300",children:t.map((i,s)=>e.jsx("li",{children:i},s))})]}),_=({placeId:a,reviews:t})=>{const[n,o]=d.useState(null),[l,i]=d.useState(!0),[s,r]=d.useState(null);return d.useEffect(()=>{(async()=>{if(!t||t.length===0){i(!1);return}i(!0),r(null);try{const m=t.map(w=>w.text).join(`

`),f=await k(a,m);o(f)}catch(m){console.error("Failed to generate review summary:",m),r("AIによる要約の生成に失敗しました。")}finally{i(!1)}})()},[a,t]),l?e.jsx(E,{}):s?e.jsx("p",{className:"text-red-500 text-sm",children:s}):!n||n.goodPoints.length===0&&n.badPoints.length===0&&n.tips.length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"要約を生成するのに十分なレビューがありません。"}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(y,{title:"良い点",points:n.goodPoints,icon:e.jsx(P,{className:"w-5 h-5"}),borderColorClass:"border-green-400 dark:border-green-500",textColorClass:"text-green-700 dark:text-green-400"}),e.jsx(y,{title:"惜しい点",points:n.badPoints,icon:e.jsx(N,{className:"w-5 h-5"}),borderColorClass:"border-red-400 dark:border-red-500",textColorClass:"text-red-700 dark:text-red-400"}),e.jsx(y,{title:"ヒント",points:n.tips,icon:e.jsx(j,{className:"w-5 h-5"}),borderColorClass:"border-blue-400 dark:border-blue-500",textColorClass:"text-blue-700 dark:text-blue-400"})]})},q=S.memo(_);export{q as R};
